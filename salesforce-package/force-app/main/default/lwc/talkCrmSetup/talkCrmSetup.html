<template>
    <lightning-card title="TalkCRM Setup" icon-name="custom:custom14">
        <!-- Loading State - shown during initial setup state fetch -->
        <template lwc:if={isLoading}>
            <div class="slds-p-around_large slds-text-align_center">
                <lightning-spinner alternative-text="Loading setup state" size="medium"></lightning-spinner>
                <p class="slds-m-top_medium slds-text-body_regular">Loading your setup status...</p>
            </div>
        </template>

        <!-- Main Content - shown after setup state is loaded -->
        <template lwc:else>
            <!-- Step Indicator -->
            <div class="slds-p-horizontal_medium">
                <lightning-progress-indicator current-step={currentStep} type="path" variant="base">
                    <lightning-progress-step label="Configure App" value="1"></lightning-progress-step>
                    <lightning-progress-step label="Connect Salesforce" value="2"></lightning-progress-step>
                    <lightning-progress-step label="Verify Phone" value="3"></lightning-progress-step>
                    <lightning-progress-step label="Ready!" value="4"></lightning-progress-step>
                </lightning-progress-indicator>
            </div>

            <div class="slds-p-around_medium">
                <!-- Step 1: Configure Connected App -->
            <template lwc:if={isStep1}>
                <div class="slds-text-align_center slds-p-around_large">
                    <lightning-icon icon-name="standard:connected_apps" size="large" class="slds-m-bottom_medium"></lightning-icon>
                    <h2 class="slds-text-heading_medium slds-m-bottom_small">Configure Connected App</h2>
                    <p class="slds-text-body_regular slds-m-bottom_medium">
                        TalkCRM needs OAuth credentials from your org's Connected App to securely access Salesforce.
                    </p>

                    <div class="slds-box slds-theme_shade slds-m-bottom_medium" style="max-width: 600px; margin: 0 auto; text-align: left;">
                        <h4 class="slds-text-title_bold slds-m-bottom_small">How to get your credentials:</h4>
                        <ol class="slds-list_ordered">
                            <li class="slds-m-bottom_x-small">Go to <strong>Setup</strong> → <strong>App Manager</strong></li>
                            <li class="slds-m-bottom_x-small">Find <strong>TalkCRM Voice Assistant</strong> in the list and click the dropdown arrow → <strong>View</strong></li>
                            <li class="slds-m-bottom_x-small">Click <strong>Manage Consumer Details</strong> (you may need to verify your identity)</li>
                            <li class="slds-m-bottom_x-small">Copy the <strong>Consumer Key</strong> and <strong>Consumer Secret</strong></li>
                        </ol>
                    </div>

                    <div style="max-width: 400px; margin: 0 auto;">
                        <div class="slds-form-element slds-m-bottom_medium">
                            <lightning-input
                                type="text"
                                label="Consumer Key"
                                placeholder="3MVG9..."
                                value={consumerKey}
                                onchange={handleConsumerKeyChange}
                                required>
                            </lightning-input>
                        </div>
                        <div class="slds-form-element slds-m-bottom_medium">
                            <lightning-input
                                type="password"
                                label="Consumer Secret"
                                placeholder="Enter Consumer Secret"
                                value={consumerSecret}
                                onchange={handleConsumerSecretChange}
                                required>
                            </lightning-input>
                        </div>
                        <lightning-button
                            variant="brand"
                            label="Save Credentials"
                            onclick={handleSaveCredentials}
                            disabled={isLoading}
                            class="slds-m-top_medium">
                        </lightning-button>
                    </div>

                    <template lwc:if={isLoading}>
                        <lightning-spinner alternative-text="Loading" size="small" class="slds-m-top_medium"></lightning-spinner>
                    </template>
                </div>
            </template>

            <!-- Step 2: Connect Salesforce -->
            <template lwc:if={isStep2}>
                <div class="slds-text-align_center slds-p-around_large">
                    <lightning-icon icon-name="standard:connected_apps" size="large" class="slds-m-bottom_medium"></lightning-icon>
                    <h2 class="slds-text-heading_medium slds-m-bottom_small">Connect Your Salesforce Account</h2>
                    <p class="slds-text-body_regular slds-m-bottom_large">
                        Now authorize TalkCRM to access your Salesforce data so you can manage your CRM by voice.
                    </p>

                    <template lwc:if={isConnected}>
                        <div class="slds-box slds-theme_success slds-m-bottom_medium">
                            <lightning-icon icon-name="utility:success" variant="inverse" size="small" class="slds-m-right_x-small"></lightning-icon>
                            Connected as: <strong>{userEmail}</strong>
                        </div>
                        <lightning-button variant="brand" label="Continue to Phone Setup" onclick={goToStep3}></lightning-button>
                    </template>

                    <template lwc:else>
                        <lightning-button variant="brand" label="Connect Salesforce" onclick={startOAuth} disabled={isLoading}></lightning-button>
                        <template lwc:if={isLoading}>
                            <lightning-spinner alternative-text="Loading" size="small" class="slds-m-left_medium"></lightning-spinner>
                        </template>
                    </template>
                </div>
            </template>

            <!-- Step 3: Phone Verification -->
            <template lwc:if={isStep3}>
                <div class="slds-text-align_center slds-p-around_large">
                    <lightning-icon icon-name="standard:call" size="large" class="slds-m-bottom_medium"></lightning-icon>
                    <h2 class="slds-text-heading_medium slds-m-bottom_small">Verify Your Phone Number</h2>
                    <p class="slds-text-body_regular slds-m-bottom_large">
                        Add your phone number to call TalkCRM. We'll send a verification code.
                    </p>

                    <template lwc:if={showPhoneInput}>
                        <div class="slds-form-element slds-m-bottom_medium" style="max-width: 300px; margin: 0 auto;">
                            <lightning-input
                                type="tel"
                                label="Phone Number"
                                placeholder="+1 (555) 123-4567"
                                value={phoneNumber}
                                onchange={handlePhoneChange}
                                required>
                            </lightning-input>
                        </div>
                        <lightning-button variant="brand" label="Send Verification Code" onclick={handleSendVerificationCode} disabled={isLoading}></lightning-button>
                    </template>

                    <template lwc:if={showCodeInput}>
                        <div class="slds-box slds-theme_shade slds-m-bottom_medium">
                            <p>Code sent to: <strong>{phoneNumber}</strong></p>
                        </div>
                        <div class="slds-form-element slds-m-bottom_medium" style="max-width: 200px; margin: 0 auto;">
                            <lightning-input
                                type="text"
                                label="Verification Code"
                                placeholder="123456"
                                value={verificationCode}
                                onchange={handleCodeChange}
                                maxlength="6"
                                required>
                            </lightning-input>
                        </div>
                        <lightning-button variant="brand" label="Verify Code" onclick={handleVerifyCode} disabled={isLoading}></lightning-button>
                        <lightning-button variant="base" label="Resend Code" onclick={handleSendVerificationCode} disabled={isLoading} class="slds-m-left_small"></lightning-button>
                    </template>

                    <template lwc:if={isLoading}>
                        <lightning-spinner alternative-text="Loading" size="small" class="slds-m-top_medium"></lightning-spinner>
                    </template>
                </div>
            </template>

            <!-- Step 4: Complete -->
            <template lwc:if={isStep4}>
                <div class="slds-text-align_center slds-p-around_large">
                    <lightning-icon icon-name="action:approval" size="large" class="slds-m-bottom_medium"></lightning-icon>
                    <h2 class="slds-text-heading_medium slds-m-bottom_small">You're All Set!</h2>
                    <p class="slds-text-body_regular slds-m-bottom_large">
                        TalkCRM is ready to use. Call or text the number below to manage your Salesforce.
                    </p>

                    <div class="slds-grid slds-wrap slds-gutters slds-m-bottom_large" style="max-width: 600px; margin: 0 auto;">
                        <!-- Call Box -->
                        <div class="slds-col slds-size_1-of-1 slds-medium-size_1-of-2 slds-m-bottom_small">
                            <div class="slds-box slds-theme_default" style="height: 100%;">
                                <h3 class="slds-text-heading_small slds-m-bottom_small">
                                    <lightning-icon icon-name="utility:call" size="small" class="slds-m-right_x-small"></lightning-icon>
                                    Call
                                </h3>
                                <p class="slds-text-heading_medium slds-text-color_success">
                                    +1 (646) 600-5041
                                </p>
                                <p class="slds-text-body_small slds-m-top_small slds-text-color_weak">
                                    Voice AI assistant
                                </p>
                            </div>
                        </div>
                        <!-- Text Box -->
                        <div class="slds-col slds-size_1-of-1 slds-medium-size_1-of-2 slds-m-bottom_small">
                            <div class="slds-box slds-theme_default" style="height: 100%;">
                                <h3 class="slds-text-heading_small slds-m-bottom_small">
                                    <lightning-icon icon-name="utility:chat" size="small" class="slds-m-right_x-small"></lightning-icon>
                                    Text
                                </h3>
                                <p class="slds-text-heading_medium slds-text-color_success">
                                    +1 (656) 252-4906
                                </p>
                                <p class="slds-text-body_small slds-m-top_small slds-text-color_weak">
                                    iMessage &amp; SMS supported
                                </p>
                            </div>
                        </div>
                    </div>

                    <p class="slds-text-body_small slds-text-color_weak slds-m-bottom_medium">
                        Registered phone: {phoneNumber}
                    </p>

                    <div class="slds-box slds-theme_shade slds-m-bottom_large" style="max-width: 500px; margin: 0 auto;">
                        <h4 class="slds-text-title_bold slds-m-bottom_small">Try saying or texting:</h4>
                        <ul class="slds-list_dotted slds-text-align_left">
                            <li>"What's in my pipeline?"</li>
                            <li>"Find the Acme account"</li>
                            <li>"Create a task to call John tomorrow"</li>
                            <li>"Update the Acme deal to Closed Won"</li>
                        </ul>
                    </div>

                    <!-- Manage Settings Section -->
                    <div class="slds-box slds-theme_default" style="max-width: 500px; margin: 0 auto;">
                        <h4 class="slds-text-title_bold slds-m-bottom_medium">
                            <lightning-icon icon-name="utility:settings" size="x-small" class="slds-m-right_x-small"></lightning-icon>
                            Manage Settings
                        </h4>
                        <div class="slds-grid slds-wrap slds-gutters_small">
                            <div class="slds-col slds-size_1-of-1 slds-medium-size_1-of-2 slds-m-bottom_small">
                                <lightning-button
                                    variant="neutral"
                                    label="Change Phone Number"
                                    onclick={handleChangePhone}
                                    icon-name="utility:phone_portrait"
                                    class="full-width-button">
                                </lightning-button>
                            </div>
                            <div class="slds-col slds-size_1-of-1 slds-medium-size_1-of-2 slds-m-bottom_small">
                                <lightning-button
                                    variant="neutral"
                                    label="Reconnect Salesforce"
                                    onclick={handleReconnectSalesforce}
                                    icon-name="utility:refresh"
                                    class="full-width-button">
                                </lightning-button>
                            </div>
                            <div class="slds-col slds-size_1-of-1 slds-medium-size_1-of-2 slds-m-bottom_small">
                                <lightning-button
                                    variant="neutral"
                                    label="Update App Credentials"
                                    onclick={handleReconfigureCredentials}
                                    icon-name="utility:key"
                                    class="full-width-button">
                                </lightning-button>
                            </div>
                            <div class="slds-col slds-size_1-of-1 slds-medium-size_1-of-2 slds-m-bottom_small">
                                <lightning-button
                                    variant="destructive-text"
                                    label="Reset All Settings"
                                    onclick={handleResetAll}
                                    icon-name="utility:delete"
                                    class="full-width-button">
                                </lightning-button>
                            </div>
                        </div>
                    </div>
                </div>
            </template>

            <!-- Success Message -->
            <template lwc:if={successMessage}>
                <div class="slds-notify slds-notify_alert slds-alert_success slds-m-top_medium" role="alert">
                    <lightning-icon icon-name="utility:success" variant="inverse" size="x-small" class="slds-m-right_x-small"></lightning-icon>
                    {successMessage}
                </div>
            </template>

            <!-- Error Display -->
            <template lwc:if={errorMessage}>
                <div class="slds-notify slds-notify_alert slds-alert_error slds-m-top_medium" role="alert">
                    <lightning-icon icon-name="utility:error" variant="inverse" size="x-small" class="slds-m-right_x-small"></lightning-icon>
                    {errorMessage}
                </div>
            </template>
            </div>
        </template>
    </lightning-card>
</template>
